<html>
<head>
  <title>WM visual array task</title>
  <script src="jspsych-6.0.4/jspsych.js"></script>
  <script src="jspsych-6.0.4/plugins/jspsych-html-keyboard-response.js"></script>
  <script src="jspsych-6.0.4/plugins/jspsych-visual-array-stimuli.js"></script>
  <script src="jspsych-6.0.4/plugins/jspsych-visual-array-response.js"></script>
  <script src="jspsych-6.0.4/plugins/jspsych-survey-text.js"></script>
  <script src="jspsych-6.0.4/plugins/jspsych-instructions.js"></script>
  <script src="jspsych-6.0.4/plugins/jspsych-fullscreen.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jstat@latest/dist/jstat.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
  <link href="jspsych-6.0.4/css/jspsych_visualarray.css" rel="stylesheet" type="text/css"></link>
</head>
<body>
</body>
<script>

//----- CUSTOMIZABLE VARIABLES -----------------------------------------

var setSizes = [4, 8]; // set sizes (number of squares displayed in different visual array trials)
var repSet = 16; // number of times each set size should be repeated per block
var blocks = 3; // number of blocks
var stimuli_duration = 100; // number of milliseconds to display each stimuli
var recall_duration = null; // number of milliseconds to allow recall. If null, there is no time limit.
var file_name = null; // file name for data file. if null, a default name consisting of the participant ID and a unique number is chosen.
var local = true; // save the data file locally.

//----------------------------------------------------------------------

var stimuliArr = [];
for (var b = 0; b < blocks; b++) {
  for (var i = 0; i < setSizes.length; i++) {
    for (var h = 1; h <= repSet; h++) {
      stimuliArr.push([setSizes[i], true]);
      stimuliArr.push([setSizes[i], false]);
    }
  }
}

var n = -1;

var p_details = {
  type: "survey-text",
  questions: [{prompt: "Enter subject number"}],
  on_finish: function() {
    partN = jsPsych.data.get().last(1).values()[0].responses;
    partN = partN.replace(/['"]+/g, '');
  }
};

var instructions = {
  type: 'instructions',
  pages: [
    '<div style="font-size:20px;"><b>INSTRUCTIONS</b><br><br>This is a visual array task. On each trial, you will be shown a set of four or eight squares. You will then be shown a test square, which may or may not have changed color. Your task is to indicate whether the test square\'s color matches that of the original set.<br><br>Press "S" if the color is the SAME and "K" if the color is DIFFERENT.<br><br>Press "K" to continue.</div>'
  ],
  allow_backward: false,
  key_forward: "k"
};

var fixation = {
  type: 'html-keyboard-response',
  stimulus: '<div style="font-size:40px;">+</div>',
  choices: jsPsych.NO_KEYS,
  trial_duration: 900
};

var reward = {
  type: "visual-array-stimuli",
  set_size: function() {
    n++;
    return stimuliArr[n][0];
  },
  target_size: [16, 16],
  trial_duration: stimuli_duration
};

var recall = {
  type: "visual-array-response",
  target_size: [16, 16],
  locs: function() {
    return jsPsych.data.get().last(2).values()[0].locations;
  },
  cols: function() {
    return jsPsych.data.get().last(2).values()[0].colours;
  },
  target_different: function() {
    return stimuliArr[n][1];
  },
  trial_duration: recall_duration
};

var feedback = {
  type: 'html-keyboard-response',
  stimulus: function() {
    var text = "";
    var accuracy = jsPsych.data.get().last(1).values()[0].correct;
    if (accuracy) {
      text += '<div style="font-size:35px; color:green;"><b>Correct</b></div>';
    } else {
      text += '<div style="font-size:35px; color:red;"><b>Incorrect</b></div>';
    }
    return text;
  },
  choices: jsPsych.NO_KEYS,
  trial_duration: 1000
};

var full_procedure = {
  timeline: [instructions, fixation, reward, fixation, recall, feedback],
  repetitions: 48 // Each block will consist of 48 trials
};

var timeline = [p_details];

timeline.push({
  type: 'fullscreen',
  fullscreen_mode: true
});

for (var b = 0; b < blocks; b++) {
  timeline.push(full_procedure);
}

timeline.push({
  type: 'fullscreen',
  fullscreen_mode: false
});

var dataLog = {
  type: 'html-keyboard-response',
  stimulus: " ",
  trial_duration: 100,
  on_finish: function(data) {
    var data = jsPsych.data.get();
    if (file_name == null) {
      file_name = "WM_visual_array_" + partN + "_" + Date.now() + ".csv";
    } else {
      file_name += ".csv";
    }
    if (local) {
      data.localSave('csv', file_name);
    } else {
      saveData(file_name, data.csv());
    }
  }
};

timeline.push(dataLog);

var conclusion = {
  type: 'html-keyboard-response',
  stimulus: '<div style="font-size:20px;">This task is over. Thank you for your participation.</div>',
  choices: jsPsych.NO_KEYS
};

timeline.push(conclusion);

jsPsych.init({
  timeline: timeline,
  on_finish: function() {
    jsPsych.data.displayData();
  }
});

</script>
</html>
